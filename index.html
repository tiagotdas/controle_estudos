<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyTracker Pro - An√°lise e Controle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- √çcones Lucide para interface mais limpa -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' }
                    }
                }
            }
        }
        // Aplica o tema escuro imediatamente se salvo ou se for prefer√™ncia do sistema
        if (localStorage.getItem('studyLogDarkMode') === 'true' || (!('studyLogDarkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Heatmap Grid */
        .heatmap-grid {
            display: grid;
            grid-template-rows: repeat(7, 12px);
            grid-auto-flow: column;
            gap: 3px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .heatmap-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200 min-h-screen flex flex-col">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2 pointer-events-none"></div>

    <!-- Top Navigation -->
    <nav class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <i data-lucide="graduation-cap" class="text-brand-600 dark:text-brand-500 w-8 h-8"></i>
                    <span class="font-bold text-xl tracking-tight">StudyTracker <span class="text-brand-600 dark:text-brand-400">Pro</span></span>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Backup Actions -->
                    <div class="hidden md:flex gap-2 mr-4 border-r pr-4 dark:border-gray-700">
                        <input type="file" id="import-json" class="hidden" accept=".json">
                        <button onclick="document.getElementById('import-json').click()" class="p-2 text-gray-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors" title="Importar Backup (JSON)">
                            <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                        </button>
                        <button id="export-json-btn" class="p-2 text-gray-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors" title="Exportar Backup (JSON)">
                            <i data-lucide="download-cloud" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <!-- Dark Mode Toggle Button -->
                    <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-brand-500">
                        <!-- Icons use Tailwind utility classes to toggle visibility automatically -->
                        <i data-lucide="moon" class="w-5 h-5 dark:hidden text-gray-600"></i>
                        <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-yellow-400"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow">
        
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 fade-in">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4">
                <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400">
                    <i data-lucide="clock" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Estudado</p>
                    <h3 class="text-xl font-bold" id="kpi-total-time">0h 00m</h3>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4">
                <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg text-green-600 dark:text-green-400">
                    <i data-lucide="calendar-check" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Sess√µes</p>
                    <h3 class="text-xl font-bold" id="kpi-total-sessions">0</h3>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4">
                <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg text-purple-600 dark:text-purple-400">
                    <i data-lucide="flame" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Sequ√™ncia (Streak)</p>
                    <h3 class="text-xl font-bold" id="kpi-streak">0 dias</h3>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4">
                <div class="p-3 bg-orange-100 dark:bg-orange-900/30 rounded-lg text-orange-600 dark:text-orange-400">
                    <i data-lucide="book-open" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Assunto Top</p>
                    <h3 class="text-xl font-bold truncate max-w-[120px]" id="kpi-top-subject">-</h3>
                </div>
            </div>
        </div>

        <div id="reminders-section" class="mb-8"></div>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Column: Input (4 cols) -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Timer Card -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-lg flex items-center gap-2">
                            <i data-lucide="timer" class="w-5 h-5"></i> Cron√¥metro
                        </h2>
                        <span id="session-status" class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-500">Parado</span>
                    </div>
                    
                    <div class="text-center py-6 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 mb-6 relative overflow-hidden group">
                        <div id="stopwatch-display" class="text-6xl font-mono font-bold text-gray-900 dark:text-white tracking-wider relative z-10">00:00:00</div>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <button id="start-btn" class="col-span-1 bg-brand-600 hover:bg-brand-700 text-white font-medium py-3 rounded-lg shadow-sm transition-all active:scale-95 flex justify-center items-center gap-2">
                            <i data-lucide="play" class="w-4 h-4"></i> Iniciar
                        </button>
                        <button id="pause-btn" disabled class="col-span-1 bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 rounded-lg shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                            <i data-lucide="pause" class="w-4 h-4"></i> Pausa
                        </button>
                        <button id="stop-btn" disabled class="col-span-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 rounded-lg shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                            <i data-lucide="square" class="w-4 h-4"></i> Parar
                        </button>
                    </div>
                </div>

                <!-- Form Card -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in" style="animation-delay: 0.1s;">
                    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2">
                        <i data-lucide="pen-tool" class="w-5 h-5"></i> Detalhes da Sess√£o
                    </h2>
                    <form id="study-form" class="space-y-4">
                        <!-- Assunto e Cor -->
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">O que voc√™ estudou?</label>
                            <div class="flex gap-2">
                                <div class="relative flex-grow">
                                    <input type="text" id="subject" name="subject" required placeholder="Ex: C√°lculo III" 
                                        class="block w-full pl-3 pr-10 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" list="subjects-datalist">
                                    <datalist id="subjects-datalist"></datalist>
                                </div>
                                <input type="color" id="subject-color" value="#0ea5e9" class="h-[46px] w-[46px] rounded-lg cursor-pointer bg-transparent border-0 p-0">
                            </div>
                        </div>

                        <!-- Data e Tipo -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Data</label>
                                <input type="date" id="date" name="date" required class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-brand-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Tipo</label>
                                <select id="study-type" class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-brand-500">
                                    <option value="Teoria">üìñ Teoria</option>
                                    <option value="Exerc√≠cios">üìù Exerc√≠cios</option>
                                    <option value="Revis√£o">üîÑ Revis√£o</option>
                                    <option value="Projeto">üíª Projeto</option>
                                </select>
                            </div>
                        </div>

                        <!-- Timestamps (Hidden logic mostly, but visible for edit) -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">In√≠cio</label>
                                <input type="time" id="start-time" required readonly class="block w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-transparent rounded-lg text-gray-500 cursor-not-allowed">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Fim</label>
                                <input type="time" id="end-time" required readonly class="block w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-transparent rounded-lg text-gray-500 cursor-not-allowed">
                            </div>
                        </div>

                        <!-- Coment√°rios -->
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Notas / Aula n¬∫</label>
                            <textarea id="comments" rows="2" placeholder="Aula 05 - Integrais M√∫ltiplas..." class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-brand-500 focus:border-brand-500"></textarea>
                        </div>

                        <!-- Lembrete -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Agendar Revis√£o</label>
                                <div class="flex gap-1">
                                    <button type="button" class="reminder-shortcut text-xs bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded hover:bg-gray-300" data-days="1">+1d</button>
                                    <button type="button" class="reminder-shortcut text-xs bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded hover:bg-gray-300" data-days="7">+7d</button>
                                </div>
                            </div>
                            <input type="date" id="reminder-date" class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg">
                        </div>

                        <div class="pt-2 flex gap-3">
                            <button type="button" id="clear-form" class="flex-1 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Limpar</button>
                            <button type="submit" class="flex-[2] py-2.5 bg-brand-600 hover:bg-brand-700 text-white font-semibold rounded-lg shadow-md transition-colors flex justify-center items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Column: Visualization & Data (8 cols) -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Heatmap Section -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-lg flex items-center gap-2">
                            <i data-lucide="activity" class="w-5 h-5"></i> Consist√™ncia (√öltimos 365 dias)
                        </h2>
                    </div>
                    <!-- Heatmap Container -->
                    <div class="w-full overflow-x-auto">
                         <div id="heatmap-container" class="heatmap-grid min-w-max"></div>
                    </div>
                    <div class="flex justify-end items-center gap-2 mt-2 text-xs text-gray-500">
                        <span>Menos</span>
                        <div class="w-3 h-3 rounded-sm bg-gray-200 dark:bg-gray-700"></div>
                        <div class="w-3 h-3 rounded-sm bg-brand-100 dark:bg-brand-900"></div>
                        <div class="w-3 h-3 rounded-sm bg-brand-500"></div>
                        <div class="w-3 h-3 rounded-sm bg-brand-700"></div>
                        <span>Mais</span>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in" style="animation-delay: 0.1s;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-lg">An√°lise de Tempo</h2>
                        <div class="bg-gray-100 dark:bg-gray-700 p-1 rounded-lg flex text-sm">
                            <button class="chart-toggle px-3 py-1 rounded-md bg-white dark:bg-gray-600 shadow-sm transition-all" data-type="doughnut">Pizza</button>
                            <button class="chart-toggle px-3 py-1 rounded-md text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white transition-all" data-type="bar">Barras</button>
                        </div>
                    </div>
                    <div class="h-64 w-full">
                        <canvas id="study-chart"></canvas>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in" style="animation-delay: 0.2s;">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h2 class="font-semibold text-lg flex items-center gap-2">
                            <i data-lucide="list" class="w-5 h-5"></i> Hist√≥rico
                        </h2>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <div class="relative flex-grow sm:flex-grow-0">
                                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                <input type="text" id="search-input" placeholder="Buscar..." class="pl-9 pr-3 py-2 w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm">
                            </div>
                            <button id="export-csv-btn" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg shadow-sm" title="Exportar CSV (Excel)">
                                <i data-lucide="sheet" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-lg border dark:border-gray-700">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300">
                                <tr>
                                    <th class="px-4 py-3">Assunto</th>
                                    <th class="px-4 py-3">Data</th>
                                    <th class="px-4 py-3">Dura√ß√£o</th>
                                    <th class="px-4 py-3 text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Preenchido via JS -->
                            </tbody>
                        </table>
                        <div id="empty-state" class="hidden text-center py-10">
                            <div class="inline-block p-4 rounded-full bg-gray-100 dark:bg-gray-800 mb-3">
                                <i data-lucide="inbox" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <p class="text-gray-500 dark:text-gray-400">Nenhum registro encontrado.</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Edit Modal (Simplified) -->
    <dialog id="edit-modal" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-0 w-full max-w-lg backdrop:bg-gray-900/50">
        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-bold">Editar Registro</h3>
            <button onclick="document.getElementById('edit-modal').close()" class="text-gray-500 hover:text-gray-700 dark:hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="p-6">
            <!-- Reuse form logic via JS dynamically or clone fields here. For simplicity, we build form inside JS -->
            <div id="modal-content"></div>
        </div>
    </dialog>

    <script>
        // --- CORE LOGIC & STATE ---
        const state = {
            logs: JSON.parse(localStorage.getItem('studyLogs')) || [],
            colors: JSON.parse(localStorage.getItem('subjectColors')) || {},
            timer: { interval: null, startTime: 0, elapsed: 0, isPaused: false, sessionStart: null },
            chart: null,
            chartType: 'doughnut'
        };

        // --- DOM ELEMENTS ---
        const el = id => document.getElementById(id);
        const elements = {
            display: el('stopwatch-display'),
            btnStart: el('start-btn'),
            btnPause: el('pause-btn'),
            btnStop: el('stop-btn'),
            form: el('study-form'),
            table: el('logs-table-body'),
            heatmap: el('heatmap-container'),
            toast: el('toast-container'),
            subjectList: el('subjects-datalist'),
            kpi: {
                total: el('kpi-total-time'),
                sessions: el('kpi-total-sessions'),
                streak: el('kpi-streak'),
                top: el('kpi-top-subject')
            }
        };

        // --- ICONS & UI INIT ---
        lucide.createIcons();
        
        // --- HELPERS FOR LOCAL TIMEZONE PRECISION ---
        const getLocalDateStr = (dateObj) => {
            // Returns YYYY-MM-DD respecting the local browser timezone (not UTC)
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- STOPWATCH ENGINE ---
        const formatTime = (ms) => {
            const date = new Date(ms);
            return date.toISOString().substr(11, 8);
        };

        const updateDisplay = () => {
            const now = Date.now();
            const total = state.timer.elapsed + (now - state.timer.startTime);
            elements.display.textContent = formatTime(total);
        };

        elements.btnStart.onclick = () => {
            if (!state.timer.sessionStart) state.timer.sessionStart = new Date();
            state.timer.startTime = Date.now();
            state.timer.interval = setInterval(updateDisplay, 100);
            
            elements.btnStart.disabled = true;
            elements.btnPause.disabled = false;
            elements.btnStop.disabled = false;
            el('session-status').textContent = "Em andamento...";
            el('session-status').className = "text-xs px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400";
        };

        elements.btnPause.onclick = () => {
            if (!state.timer.isPaused) {
                clearInterval(state.timer.interval);
                state.timer.elapsed += Date.now() - state.timer.startTime;
                elements.btnPause.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i> Retomar`;
                lucide.createIcons();
                el('session-status').textContent = "Pausado";
                el('session-status').className = "text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400";
            } else {
                state.timer.startTime = Date.now();
                state.timer.interval = setInterval(updateDisplay, 100);
                elements.btnPause.innerHTML = `<i data-lucide="pause" class="w-4 h-4"></i> Pausa`;
                lucide.createIcons();
                el('session-status').textContent = "Em andamento...";
                el('session-status').className = "text-xs px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400";
            }
            state.timer.isPaused = !state.timer.isPaused;
        };

        elements.btnStop.onclick = () => {
            clearInterval(state.timer.interval);
            const now = new Date();
            
            // Auto-fill form
            const pad = n => String(n).padStart(2,'0');
            el('start-time').value = `${pad(state.timer.sessionStart.getHours())}:${pad(state.timer.sessionStart.getMinutes())}`;
            el('end-time').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            el('date').value = getLocalDateStr(new Date()); // Ensure local date for form

            // Reset Timer
            elements.display.textContent = "00:00:00";
            state.timer = { interval: null, startTime: 0, elapsed: 0, isPaused: false, sessionStart: null };
            
            elements.btnStart.disabled = false;
            elements.btnPause.disabled = true;
            elements.btnStop.disabled = true;
            elements.btnPause.innerHTML = `<i data-lucide="pause" class="w-4 h-4"></i> Pausa`;
            el('session-status').textContent = "Finalizado - Salve abaixo";
            el('session-status').className = "text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 animate-pulse";
            lucide.createIcons();
            
            // Scroll to form
            elements.form.scrollIntoView({ behavior: 'smooth' });
            el('subject').focus();
        };

        // --- DATA MANAGEMENT ---
        const saveData = () => {
            localStorage.setItem('studyLogs', JSON.stringify(state.logs));
            localStorage.setItem('subjectColors', JSON.stringify(state.colors));
            updateUI();
        };

        const calcDurationStr = (start, end) => {
            const d1 = new Date(`1970-01-01T${start}`);
            const d2 = new Date(`1970-01-01T${end}`);
            let diff = (d2 - d1) / 60000; // minutes
            if (diff < 0) diff += 24 * 60;
            const h = Math.floor(diff / 60);
            const m = Math.floor(diff % 60);
            return `${h}h ${String(m).padStart(2,'0')}m`;
        };

        const calcMinutes = (durationStr) => {
            const match = durationStr.match(/(\d+)h (\d+)m/);
            return match ? parseInt(match[1])*60 + parseInt(match[2]) : 0;
        };

        elements.form.onsubmit = (e) => {
            e.preventDefault();
            const fd = new FormData(elements.form);
            const subject = fd.get('subject').trim();
            
            // Save Color preference
            state.colors[subject] = el('subject-color').value;

            const newLog = {
                id: Date.now(),
                subject,
                color: el('subject-color').value,
                date: fd.get('date'),
                type: el('study-type').value,
                startTime: fd.get('start-time'),
                endTime: fd.get('end-time'),
                duration: calcDurationStr(fd.get('start-time'), fd.get('end-time')),
                comments: el('comments').value,
                reminder: el('reminder-date').value
            };

            state.logs.push(newLog);
            saveData();
            elements.form.reset();
            el('date').value = getLocalDateStr(new Date()); // Reset to local date
            el('subject-color').value = '#0ea5e9'; // reset color
            el('session-status').textContent = "Parado";
            el('session-status').className = "text-xs px-2 py-1 rounded bg-gray-100 text-gray-500";
            showToast("Sess√£o registrada com sucesso!", "success");
        };

        // --- HEATMAP LOGIC ---
        const renderHeatmap = () => {
            elements.heatmap.innerHTML = '';
            const today = new Date();
            // Start 365 days ago
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 364);
            
            // Group logs by date
            const logsByDate = {};
            state.logs.forEach(l => {
                const mins = calcMinutes(l.duration);
                logsByDate[l.date] = (logsByDate[l.date] || 0) + mins;
            });

            // Generate Grid
            for (let i = 0; i < 365; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                
                // FIXED: Use Local Time String generator to match 'date' input values
                const dateStr = getLocalDateStr(d);
                
                const minutes = logsByDate[dateStr] || 0;
                
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell transition-all hover:scale-125';
                
                const dayName = d.toLocaleDateString('pt-BR', { weekday: 'short' });
                const dateDisplay = d.toLocaleDateString('pt-BR');
                cell.title = `${dayName}, ${dateDisplay}: ${Math.floor(minutes/60)}h ${minutes%60}m`;
                
                // Color Logic
                if (minutes === 0) cell.classList.add('bg-gray-200', 'dark:bg-gray-700');
                else if (minutes < 30) cell.classList.add('bg-brand-100', 'dark:bg-brand-900');
                else if (minutes < 90) cell.classList.add('bg-brand-500');
                else cell.classList.add('bg-brand-700');

                elements.heatmap.appendChild(cell);
            }
        };

        // --- KPI & CHART LOGIC ---
        const calculateKPIs = () => {
            // Total Time & Sessions
            const totalMin = state.logs.reduce((acc, l) => acc + calcMinutes(l.duration), 0);
            elements.kpi.total.textContent = `${Math.floor(totalMin/60)}h ${totalMin%60}m`;
            elements.kpi.sessions.textContent = state.logs.length;

            // Top Subject
            const subjects = {};
            state.logs.forEach(l => subjects[l.subject] = (subjects[l.subject] || 0) + calcMinutes(l.duration));
            const sortedSubj = Object.entries(subjects).sort((a,b) => b[1] - a[1]);
            elements.kpi.top.textContent = sortedSubj.length ? sortedSubj[0][0] : '-';

            // Current Streak
            // Logic: Sort dates unique desc, check consecutive days
            const uniqueDates = [...new Set(state.logs.map(l => l.date))].sort().reverse();
            let streak = 0;
            if (uniqueDates.length > 0) {
                const today = getLocalDateStr(new Date());
                const yesterdayObj = new Date();
                yesterdayObj.setDate(yesterdayObj.getDate() - 1);
                const yesterday = getLocalDateStr(yesterdayObj);
                
                // If studied today or yesterday, streak is active
                let currentCheck = uniqueDates[0] === today ? today : (uniqueDates[0] === yesterday ? yesterday : null);
                
                if (currentCheck) {
                    streak = 1;
                    for (let i = 1; i < uniqueDates.length; i++) {
                        const prev = new Date(currentCheck);
                        prev.setDate(prev.getDate() - 1);
                        // Fix previous date string calculation too
                        // Note: Date strings in uniqueDates are YYYY-MM-DD from input[type=date]
                        // We must parse them correctly to subtract days without timezone shift
                        const parts = currentCheck.split('-');
                        const dObj = new Date(parts[0], parts[1]-1, parts[2]); // Local constructor
                        dObj.setDate(dObj.getDate() - 1);
                        const expectedStr = getLocalDateStr(dObj);

                        if (uniqueDates[i] === expectedStr) {
                            streak++;
                            currentCheck = expectedStr;
                        } else break;
                    }
                }
            }
            elements.kpi.streak.textContent = `${streak} dias`;
        };

        const renderChart = () => {
            if (state.chart) state.chart.destroy();
            const ctx = el('study-chart').getContext('2d');
            
            const subjData = {};
            state.logs.forEach(l => subjData[l.subject] = (subjData[l.subject] || 0) + calcMinutes(l.duration));
            
            const labels = Object.keys(subjData);
            const data = Object.values(subjData);
            const bgColors = labels.map(l => state.colors[l] || '#cbd5e1');

            state.chart = new Chart(ctx, {
                type: state.chartType,
                data: {
                    labels,
                    datasets: [{
                        label: 'Minutos',
                        data,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: document.documentElement.classList.contains('dark') ? '#94a3b8' : '#475569' } }
                    }
                }
            });
        };

        // --- RENDER TABLE & MISC ---
        const updateUI = () => {
            // Render Table
            elements.table.innerHTML = '';
            const filter = el('search-input').value.toLowerCase();
            const filtered = state.logs.filter(l => l.subject.toLowerCase().includes(filter) || (l.comments||'').toLowerCase().includes(filter));
            
            if (filtered.length === 0) el('empty-state').classList.remove('hidden');
            else el('empty-state').classList.add('hidden');

            filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(log => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b dark:border-gray-700";
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-8 rounded-full" style="background:${state.colors[log.subject] || '#ccc'}"></div>
                            <div>
                                <div class="font-medium dark:text-gray-200">${log.subject}</div>
                                <div class="text-xs text-gray-500">${log.type || 'Geral'} ‚Ä¢ ${log.comments ? log.comments.substring(0,20)+'...' : ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-gray-500 dark:text-gray-400 text-xs">
                        ${log.date.split('-').reverse().join('/')}
                    </td>
                    <td class="px-4 py-3 font-mono text-xs dark:text-gray-300">
                        ${log.duration}
                    </td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="deleteLog(${log.id})" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1.5 rounded-md transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                elements.table.appendChild(row);
            });
            lucide.createIcons();
            
            // Datalist update
            const subjects = [...new Set(state.logs.map(l => l.subject))];
            elements.subjectList.innerHTML = subjects.map(s => `<option value="${s}">`).join('');

            calculateKPIs();
            renderHeatmap();
            renderChart();
            checkReminders();
        };

        // --- GLOBAL ACTIONS ---
        window.deleteLog = (id) => {
            if(confirm('Apagar registro?')) {
                state.logs = state.logs.filter(l => l.id !== id);
                saveData();
                showToast("Registro apagado", "error");
            }
        };

        el('search-input').oninput = updateUI;
        
        document.querySelectorAll('.chart-toggle').forEach(btn => {
            btn.onclick = (e) => {
                state.chartType = e.target.dataset.type;
                renderChart();
                // Toggle active styles logic here simplified
            }
        });

        // Dark Mode Toggle Logic (Fix)
        el('dark-mode-toggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('studyLogDarkMode', isDark);
            
            // We need to re-render chart to update the legend text colors
            renderChart();
        };

        // Reminders Check
        const checkReminders = () => {
            el('reminders-section').innerHTML = '';
            const today = getLocalDateStr(new Date()); // Use local date for check
            const due = state.logs.filter(l => l.reminder && l.reminder <= today);
            
            if(due.length) {
                const div = document.createElement('div');
                div.className = "bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded shadow-sm flex items-start gap-3 dark:bg-yellow-900/20 dark:border-yellow-600";
                div.innerHTML = `
                    <i data-lucide="bell-ring" class="w-5 h-5 text-yellow-600 dark:text-yellow-400 mt-0.5"></i>
                    <div>
                        <h4 class="font-bold text-yellow-800 dark:text-yellow-200 text-sm">Hora de Revisar!</h4>
                        <ul class="text-xs text-yellow-700 dark:text-yellow-300 mt-1 list-disc list-inside">
                            ${due.map(l => `<li>${l.subject} (${l.date.split('-').reverse().join('/')})</li>`).join('')}
                        </ul>
                    </div>
                `;
                el('reminders-section').appendChild(div);
                lucide.createIcons();
            }
        };

        // Shortcuts
        document.querySelectorAll('.reminder-shortcut').forEach(btn => {
            btn.onclick = (e) => {
                // Parse date input safely manually to avoid UTC conversion
                const currentVal = el('date').value;
                let d;
                if(currentVal) {
                    const parts = currentVal.split('-');
                    d = new Date(parts[0], parts[1]-1, parts[2]);
                } else {
                    d = new Date();
                }
                
                d.setDate(d.getDate() + parseInt(e.target.dataset.days));
                el('reminder-date').value = getLocalDateStr(d);
            };
        });

        // Color sync
        el('subject').addEventListener('input', (e) => {
            if(state.colors[e.target.value]) el('subject-color').value = state.colors[e.target.value];
        });

        // Toast
        const showToast = (msg, type) => {
            const t = document.createElement('div');
            t.className = `px-4 py-2 rounded shadow-lg text-white text-sm font-medium animate-bounce ${type === 'error' ? 'bg-red-500' : 'bg-green-600'}`;
            t.textContent = msg;
            elements.toast.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        };

        // Export/Import JSON
        el('export-json-btn').onclick = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ logs: state.logs, colors: state.colors }));
            const link = document.createElement('a');
            link.setAttribute("href", dataStr);
            link.setAttribute("download", "study_backup_" + getLocalDateStr(new Date()) + ".json");
            link.click();
        };

        el('import-json').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if(data.logs) {
                        state.logs = data.logs;
                        state.colors = data.colors || {};
                        saveData();
                        showToast("Backup restaurado com sucesso!", "success");
                    }
                } catch(err) {
                    showToast("Erro ao ler arquivo JSON", "error");
                }
            };
            reader.readAsText(file);
        };

        // Initialize
        el('date').value = getLocalDateStr(new Date());
        updateUI();

    </script>
</body>
</html>
