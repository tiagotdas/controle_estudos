<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyTracker Pro - Math Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- MathJax para renderiza√ß√£o de f√≥rmulas matem√°ticas (C√°lculo) -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' }
                    }
                }
            }
        }
        if (localStorage.getItem('studyLogDarkMode') === 'true' || (!('studyLogDarkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .heatmap-grid {
            display: grid;
            grid-template-rows: repeat(7, 12px);
            grid-auto-flow: column;
            gap: 3px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .heatmap-cell { width: 12px; height: 12px; border-radius: 2px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200 min-h-screen flex flex-col">

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2 pointer-events-none"></div>

    <nav class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <i data-lucide="sigma" class="text-brand-600 dark:text-brand-500 w-8 h-8"></i>
                    <span class="font-bold text-xl tracking-tight">StudyTracker <span class="text-brand-600 dark:text-brand-400">v3.3</span></span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden md:flex gap-2 mr-4 border-r pr-4 dark:border-gray-700">
                        <input type="file" id="import-json" class="hidden" accept=".json">
                        <button onclick="document.getElementById('import-json').click()" class="p-2 text-gray-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors" title="Importar Backup (JSON)">
                            <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                        </button>
                        <button id="export-json-btn" class="p-2 text-gray-500 hover:text-brand-600 dark:hover:text-brand-400 transition-colors" title="Exportar Backup (JSON)">
                            <i data-lucide="download-cloud" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-brand-500">
                        <i data-lucide="moon" class="w-5 h-5 dark:hidden text-gray-600"></i>
                        <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-yellow-400"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow">
        
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 fade-in">
            <!-- Card 1: Total -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4 transition-all hover:shadow-md">
                <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400">
                    <i data-lucide="clock" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total (Filtrado)</p>
                    <h3 class="text-xl font-bold" id="kpi-total-time">0h 00m</h3>
                </div>
            </div>

            <!-- Card 2: Streak (Restaurado) -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4 transition-all hover:shadow-md">
                <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg text-green-600 dark:text-green-400">
                    <i data-lucide="flame" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Sequ√™ncia</p>
                    <h3 class="text-xl font-bold" id="kpi-streak">0 dias</h3>
                </div>
            </div>

            <!-- Card 3: M√©dia Di√°ria -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4 transition-all hover:shadow-md">
                <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg text-purple-600 dark:text-purple-400">
                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">M√©dia Di√°ria (30d)</p>
                    <h3 class="text-xl font-bold" id="kpi-avg-daily">0h 00m</h3>
                </div>
            </div>

            <!-- Card 4: Foco Principal -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 flex items-center gap-4 transition-all hover:shadow-md">
                <div class="p-3 bg-orange-100 dark:bg-orange-900/30 rounded-lg text-orange-600 dark:text-orange-400">
                    <i data-lucide="book-open" class="w-6 h-6"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Principal Foco</p>
                    <h3 class="text-xl font-bold truncate max-w-[120px]" id="kpi-top-subject">-</h3>
                </div>
            </div>
        </div>

        <div id="reminders-section" class="mb-8"></div>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Column: Input (4 cols) -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Timer Card -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-lg flex items-center gap-2">
                            <i data-lucide="timer" class="w-5 h-5"></i> Cron√¥metro
                        </h2>
                        <span id="session-status" class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-500">Parado</span>
                    </div>
                    
                    <div class="text-center py-6 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 mb-6 relative overflow-hidden group">
                        <div id="stopwatch-display" class="text-6xl font-mono font-bold text-gray-900 dark:text-white tracking-wider relative z-10">00:00:00</div>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <button id="start-btn" class="col-span-1 bg-brand-600 hover:bg-brand-700 text-white font-medium py-3 rounded-lg shadow-sm transition-all active:scale-95 flex justify-center items-center gap-2">
                            <i data-lucide="play" class="w-4 h-4"></i> Iniciar
                        </button>
                        <button id="pause-btn" disabled class="col-span-1 bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 rounded-lg shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                            <i data-lucide="pause" class="w-4 h-4"></i> Pausa
                        </button>
                        <button id="stop-btn" disabled class="col-span-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 rounded-lg shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                            <i data-lucide="square" class="w-4 h-4"></i> Parar
                        </button>
                    </div>
                </div>

                <!-- Form Card -->
                <div id="form-card" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in transition-all duration-300 ring-0 ring-brand-500" style="animation-delay: 0.1s;">
                    <h2 class="font-semibold text-lg mb-4 flex items-center justify-between">
                        <span class="flex items-center gap-2"><i data-lucide="pen-tool" class="w-5 h-5"></i> <span id="form-title">Detalhes da Sess√£o</span></span>
                        <button id="cancel-edit-btn" class="hidden text-xs text-red-500 hover:underline">Cancelar Edi√ß√£o</button>
                    </h2>
                    <form id="study-form" class="space-y-4">
                        <input type="hidden" id="edit-id" name="edit-id" value="">
                        <!-- Assunto e Cor -->
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">O que voc√™ estudou?</label>
                            <div class="flex gap-2">
                                <div class="relative flex-grow">
                                    <input type="text" id="subject" name="subject" required placeholder="Ex: C√°lculo III" 
                                        class="block w-full pl-3 pr-10 py-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" list="subjects-datalist">
                                    <datalist id="subjects-datalist"></datalist>
                                </div>
                                <input type="color" id="subject-color" name="subject-color" value="#0ea5e9" class="h-[46px] w-[46px] rounded-lg cursor-pointer bg-transparent border-0 p-0">
                            </div>
                        </div>

                        <!-- Data e Tipo -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Data</label>
                                <input type="date" id="date" name="date" required class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-brand-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Tipo</label>
                                <select id="study-type" name="study-type" class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-brand-500">
                                    <option value="Teoria">üìñ Teoria</option>
                                    <option value="Exerc√≠cios">üìù Exerc√≠cios</option>
                                    <option value="Revis√£o">üîÑ Revis√£o</option>
                                    <option value="Projeto">üíª Projeto</option>
                                </select>
                            </div>
                        </div>

                        <!-- Timestamps -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">In√≠cio</label>
                                <input type="time" id="start-time" name="start-time" required class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-brand-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Fim</label>
                                <input type="time" id="end-time" name="end-time" required class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-brand-500">
                            </div>
                        </div>

                        <!-- Coment√°rios -->
                        <div>
                            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Notas (Suporta LaTeX: $\int x dx$)</label>
                            <textarea id="comments" name="comments" rows="2" placeholder="Ex: Revisei $\lim_{x \to 0} \frac{\sin x}{x}$..." class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-brand-500 focus:border-brand-500 font-mono text-sm"></textarea>
                        </div>

                        <!-- Lembrete -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Agendar Revis√£o</label>
                                <div class="flex gap-1">
                                    <button type="button" class="reminder-shortcut text-xs bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded hover:bg-gray-300" data-days="1">+1d</button>
                                    <button type="button" class="reminder-shortcut text-xs bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded hover:bg-gray-300" data-days="7">+7d</button>
                                </div>
                            </div>
                            <input type="date" id="reminder-date" name="reminder-date" class="block w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg">
                        </div>

                        <div class="pt-2 flex gap-3">
                            <button type="button" id="clear-form" class="flex-1 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Limpar</button>
                            <button type="submit" id="submit-btn" class="flex-[2] py-2.5 bg-brand-600 hover:bg-brand-700 text-white font-semibold rounded-lg shadow-md transition-colors flex justify-center items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Column: Visualization & Data (8 cols) -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Heatmap Section -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-lg flex items-center gap-2">
                            <i data-lucide="activity" class="w-5 h-5"></i> Consist√™ncia (365 dias)
                        </h2>
                    </div>
                    <div class="w-full overflow-x-auto">
                         <div id="heatmap-container" class="heatmap-grid min-w-max"></div>
                    </div>
                    <div class="flex justify-end items-center gap-2 mt-2 text-xs text-gray-500">
                        <span>Menos</span>
                        <div class="w-3 h-3 rounded-sm bg-gray-200 dark:bg-gray-700"></div>
                        <div class="w-3 h-3 rounded-sm bg-brand-100 dark:bg-brand-900"></div>
                        <div class="w-3 h-3 rounded-sm bg-brand-500"></div>
                        <div class="w-3 h-3 rounded-sm bg-brand-700"></div>
                        <span>Mais</span>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in" style="animation-delay: 0.1s;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-lg">An√°lise de Tempo</h2>
                        <div class="flex bg-gray-100 dark:bg-gray-700 p-1 rounded-lg text-sm">
                            <button class="chart-toggle px-3 py-1 rounded-md transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white" data-type="doughnut">Pizza</button>
                            <button class="chart-toggle px-3 py-1 rounded-md transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white" data-type="bar">Barras</button>
                            <button class="chart-toggle px-3 py-1 rounded-md transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white" data-type="line">Tend√™ncia</button>
                        </div>
                    </div>
                    <div class="h-64 w-full">
                        <canvas id="study-chart"></canvas>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border dark:border-gray-700 fade-in" style="animation-delay: 0.2s;">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h2 class="font-semibold text-lg flex items-center gap-2">
                            <i data-lucide="list" class="w-5 h-5"></i> Hist√≥rico
                        </h2>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <div class="relative flex-grow sm:flex-grow-0">
                                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                <input type="text" id="search-input" placeholder="Buscar (Ex: $\int$)..." class="pl-9 pr-3 py-2 w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm">
                            </div>
                            <button id="export-csv-btn" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg shadow-sm" title="Exportar CSV (Excel)">
                                <i data-lucide="sheet" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-lg border dark:border-gray-700">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300">
                                <tr>
                                    <th class="px-4 py-3">Assunto</th>
                                    <th class="px-4 py-3">Data</th>
                                    <th class="px-4 py-3">Dura√ß√£o</th>
                                    <th class="px-4 py-3 text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Preenchido via JS -->
                            </tbody>
                        </table>
                        <div id="empty-state" class="hidden text-center py-10">
                            <div class="inline-block p-4 rounded-full bg-gray-100 dark:bg-gray-800 mb-3">
                                <i data-lucide="inbox" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <p class="text-gray-500 dark:text-gray-400">Nenhum registro encontrado.</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- CORE LOGIC & STATE ---
        const state = {
            logs: JSON.parse(localStorage.getItem('studyLogs')) || [],
            colors: JSON.parse(localStorage.getItem('subjectColors')) || {},
            timer: { interval: null, startTime: 0, elapsed: 0, isPaused: false, sessionStart: null },
            chart: null,
            chartType: 'doughnut',
            editingId: null // Para controlar edi√ß√£o
        };

        const el = id => document.getElementById(id);
        const elements = {
            display: el('stopwatch-display'),
            btnStart: el('start-btn'),
            btnPause: el('pause-btn'),
            btnStop: el('stop-btn'),
            form: el('study-form'),
            table: el('logs-table-body'),
            heatmap: el('heatmap-container'),
            toast: el('toast-container'),
            subjectList: el('subjects-datalist'),
            kpi: {
                total: el('kpi-total-time'),
                streak: el('kpi-streak'),
                avgDaily: el('kpi-avg-daily'),
                top: el('kpi-top-subject')
            }
        };

        lucide.createIcons();
        
        // --- HELPERS ---
        const getLocalDateStr = (dateObj) => {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- STOPWATCH ---
        const formatTime = (ms) => new Date(ms).toISOString().substr(11, 8);

        const updateDisplay = () => {
            const now = Date.now();
            const total = state.timer.elapsed + (now - state.timer.startTime);
            elements.display.textContent = formatTime(total);
        };

        elements.btnStart.onclick = () => {
            if (!state.timer.sessionStart) state.timer.sessionStart = new Date();
            state.timer.startTime = Date.now();
            state.timer.interval = setInterval(updateDisplay, 100);
            elements.btnStart.disabled = true;
            elements.btnPause.disabled = false;
            elements.btnStop.disabled = false;
            el('session-status').textContent = "Em andamento...";
            el('session-status').className = "text-xs px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400";
        };

        elements.btnPause.onclick = () => {
            if (!state.timer.isPaused) {
                clearInterval(state.timer.interval);
                state.timer.elapsed += Date.now() - state.timer.startTime;
                elements.btnPause.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i> Retomar`;
                el('session-status').textContent = "Pausado";
                el('session-status').className = "text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400";
            } else {
                state.timer.startTime = Date.now();
                state.timer.interval = setInterval(updateDisplay, 100);
                elements.btnPause.innerHTML = `<i data-lucide="pause" class="w-4 h-4"></i> Pausa`;
                el('session-status').textContent = "Em andamento...";
                el('session-status').className = "text-xs px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400";
            }
            state.timer.isPaused = !state.timer.isPaused;
            lucide.createIcons();
        };

        elements.btnStop.onclick = () => {
            clearInterval(state.timer.interval);
            const now = new Date();
            const pad = n => String(n).padStart(2,'0');
            el('start-time').value = `${pad(state.timer.sessionStart.getHours())}:${pad(state.timer.sessionStart.getMinutes())}`;
            el('end-time').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            el('date').value = getLocalDateStr(new Date());

            elements.display.textContent = "00:00:00";
            state.timer = { interval: null, startTime: 0, elapsed: 0, isPaused: false, sessionStart: null };
            
            elements.btnStart.disabled = false;
            elements.btnPause.disabled = true;
            elements.btnStop.disabled = true;
            elements.btnPause.innerHTML = `<i data-lucide="pause" class="w-4 h-4"></i> Pausa`;
            el('session-status').textContent = "Finalizado - Salve abaixo";
            el('session-status').className = "text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 animate-pulse";
            lucide.createIcons();
            
            elements.form.scrollIntoView({ behavior: 'smooth' });
            el('subject').focus();
        };

        // --- DATA MANAGEMENT ---
        const saveData = () => {
            localStorage.setItem('studyLogs', JSON.stringify(state.logs));
            localStorage.setItem('subjectColors', JSON.stringify(state.colors));
            updateUI();
        };

        const calcDurationStr = (start, end) => {
            if (!start || !end) return "0h 00m";
            const d1 = new Date(`1970-01-01T${start}`);
            const d2 = new Date(`1970-01-01T${end}`);
            
            if (isNaN(d1.getTime()) || isNaN(d2.getTime())) return "0h 00m";

            let diff = (d2 - d1) / 60000; 
            if (diff < 0) diff += 24 * 60;
            const h = Math.floor(diff / 60);
            const m = Math.floor(diff % 60);
            return `${h}h ${String(m).padStart(2,'0')}m`;
        };

        const calcMinutes = (durationStr) => {
            if(!durationStr) return 0;
            const match = durationStr.match(/(\d+)h (\d+)m/);
            return match ? parseInt(match[1])*60 + parseInt(match[2]) : 0;
        };

        // --- FORM SUBMIT & EDITING ---
        elements.form.onsubmit = (e) => {
            e.preventDefault();
            // Corre√ß√£o Cr√≠tica: Captura direta dos valores por ID
            // Elimina depend√™ncia de 'name' e FormData que causava o bug
            const subject = el('subject').value.trim();
            const subjectColor = el('subject-color').value;
            const dateVal = el('date').value;
            const typeVal = el('study-type').value;
            const startTimeVal = el('start-time').value;
            const endTimeVal = el('end-time').value;
            const commentsVal = el('comments').value;
            const reminderVal = el('reminder-date').value;
            
            state.colors[subject] = subjectColor;

            const newLog = {
                id: state.editingId ? state.editingId : Date.now(),
                subject: subject,
                color: subjectColor,
                date: dateVal,
                type: typeVal,
                startTime: startTimeVal,
                endTime: endTimeVal,
                duration: calcDurationStr(startTimeVal, endTimeVal),
                comments: commentsVal,
                reminder: reminderVal
            };

            if (state.editingId) {
                // Update existing
                const index = state.logs.findIndex(l => l.id === state.editingId);
                if (index !== -1) state.logs[index] = newLog;
                showToast("Registro atualizado com sucesso!", "success");
                endEditMode();
            } else {
                // Create new
                state.logs.push(newLog);
                showToast("Sess√£o registrada com sucesso!", "success");
                elements.form.reset();
                el('date').value = getLocalDateStr(new Date());
                el('subject-color').value = '#0ea5e9';
            }

            saveData();
            el('session-status').textContent = "Parado";
            el('session-status').className = "text-xs px-2 py-1 rounded bg-gray-100 text-gray-500";
        };

        // Edit Mode Logic
        window.editLog = (id) => {
            const log = state.logs.find(l => l.id === id);
            if (!log) return;

            state.editingId = id;
            
            // Populate Form
            el('subject').value = log.subject;
            el('subject-color').value = log.color || state.colors[log.subject] || '#0ea5e9';
            el('date').value = log.date;
            el('study-type').value = log.type || 'Teoria';
            el('start-time').value = log.startTime || '';
            el('end-time').value = log.endTime || '';
            el('comments').value = log.comments || '';
            el('reminder-date').value = log.reminder || '';

            // UI Changes
            el('form-title').textContent = "Editando Registro";
            el('submit-btn').innerHTML = `<i data-lucide="refresh-cw" class="w-4 h-4"></i> Atualizar`;
            el('submit-btn').classList.replace('bg-brand-600', 'bg-orange-600');
            el('submit-btn').classList.replace('hover:bg-brand-700', 'hover:bg-orange-700');
            el('form-card').classList.add('ring-2');
            el('cancel-edit-btn').classList.remove('hidden');

            elements.form.scrollIntoView({ behavior: 'smooth' });
            lucide.createIcons();
        };

        const endEditMode = () => {
            state.editingId = null;
            elements.form.reset();
            el('date').value = getLocalDateStr(new Date());
            
            el('form-title').textContent = "Detalhes da Sess√£o";
            el('submit-btn').innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Salvar`;
            el('submit-btn').classList.replace('bg-orange-600', 'bg-brand-600');
            el('submit-btn').classList.replace('hover:bg-orange-700', 'hover:bg-brand-700');
            el('form-card').classList.remove('ring-2');
            el('cancel-edit-btn').classList.add('hidden');
            lucide.createIcons();
        };

        el('cancel-edit-btn').onclick = (e) => {
            e.preventDefault();
            endEditMode();
        };

        el('clear-form').onclick = () => {
             if(state.editingId) endEditMode();
             else elements.form.reset();
        };

        // --- CHARTS & KPIS ---
        const renderHeatmap = (dataSource) => {
            elements.heatmap.innerHTML = '';
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 364);
            
            const logsByDate = {};
            dataSource.forEach(l => {
                logsByDate[l.date] = (logsByDate[l.date] || 0) + calcMinutes(l.duration);
            });

            for (let i = 0; i < 365; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                const dateStr = getLocalDateStr(d);
                const minutes = logsByDate[dateStr] || 0;
                
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell transition-all hover:scale-125';
                const dayName = d.toLocaleDateString('pt-BR', { weekday: 'short' });
                const dateDisplay = d.toLocaleDateString('pt-BR');
                cell.title = `${dayName}, ${dateDisplay}: ${Math.floor(minutes/60)}h ${minutes%60}m`;
                
                if (minutes === 0) cell.classList.add('bg-gray-200', 'dark:bg-gray-700');
                else if (minutes < 30) cell.classList.add('bg-brand-100', 'dark:bg-brand-900');
                else if (minutes < 90) cell.classList.add('bg-brand-500');
                else cell.classList.add('bg-brand-700');
                elements.heatmap.appendChild(cell);
            }
        };

        const calculateKPIs = (dataSource) => {
            const totalMin = dataSource.reduce((acc, l) => acc + calcMinutes(l.duration), 0);
            elements.kpi.total.textContent = `${Math.floor(totalMin/60)}h ${totalMin%60}m`;
            
            // Avg Daily (Last 30 days of data present in filter)
            const avgMins = totalMin / 30;
            elements.kpi.avgDaily.textContent = `${Math.floor(avgMins/60)}h ${Math.floor(avgMins%60)}m`;

            const subjects = {};
            dataSource.forEach(l => subjects[l.subject] = (subjects[l.subject] || 0) + calcMinutes(l.duration));
            const sortedSubj = Object.entries(subjects).sort((a,b) => b[1] - a[1]);
            elements.kpi.top.textContent = sortedSubj.length ? sortedSubj[0][0] : '-';

            // Streak (unchanged logic)
            const uniqueDates = [...new Set(dataSource.map(l => l.date))].sort().reverse();
            let streak = 0;
            if (uniqueDates.length > 0) {
                const today = getLocalDateStr(new Date());
                const yesterdayObj = new Date();
                yesterdayObj.setDate(yesterdayObj.getDate() - 1);
                const yesterday = getLocalDateStr(yesterdayObj);
                let currentCheck = uniqueDates[0] === today ? today : (uniqueDates[0] === yesterday ? yesterday : null);
                if (currentCheck) {
                    streak = 1;
                    for (let i = 1; i < uniqueDates.length; i++) {
                        const parts = currentCheck.split('-');
                        const dObj = new Date(parts[0], parts[1]-1, parts[2]);
                        dObj.setDate(dObj.getDate() - 1);
                        const expectedStr = getLocalDateStr(dObj);
                        if (uniqueDates[i] === expectedStr) { streak++; currentCheck = expectedStr; } 
                        else break;
                    }
                }
            }
            if(elements.kpi.streak) elements.kpi.streak.textContent = `${streak} dias`;
        };

        const renderChart = (dataSource) => {
            if (state.chart) state.chart.destroy();
            const ctx = el('study-chart').getContext('2d');
            
            // Data Prep
            const chartData = { labels: [], datasets: [] };
            const isDark = document.documentElement.classList.contains('dark');

            if (state.chartType === 'line') {
                // Time Series (Last 14 Days)
                const days = [];
                const dataPoints = [];
                for(let i=13; i>=0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dStr = getLocalDateStr(d);
                    days.push(d.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}));
                    
                    const dailySum = dataSource
                        .filter(l => l.date === dStr)
                        .reduce((acc, l) => acc + calcMinutes(l.duration), 0);
                    dataPoints.push(dailySum);
                }
                
                chartData.labels = days;
                chartData.datasets = [{
                    label: 'Minutos Di√°rios',
                    data: dataPoints,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    fill: true,
                    tension: 0.4
                }];
            } else {
                // Distribution (Doughnut/Bar)
                const subjData = {};
                dataSource.forEach(l => subjData[l.subject] = (subjData[l.subject] || 0) + calcMinutes(l.duration));
                chartData.labels = Object.keys(subjData);
                chartData.datasets = [{
                    label: 'Minutos',
                    data: Object.values(subjData),
                    backgroundColor: chartData.labels.map(l => state.colors[l] || '#cbd5e1'),
                    borderWidth: 0
                }];
            }

            state.chart = new Chart(ctx, {
                type: state.chartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: isDark ? '#94a3b8' : '#475569' } }
                    },
                    scales: state.chartType === 'line' || state.chartType === 'bar' ? {
                        y: { ticks: { color: isDark ? '#94a3b8' : '#475569' }, grid: { color: isDark ? '#334155' : '#e2e8f0' } },
                        x: { ticks: { color: isDark ? '#94a3b8' : '#475569' }, grid: { display: false } }
                    } : {}
                }
            });

            // Update toggle buttons
            document.querySelectorAll('.chart-toggle').forEach(btn => {
                if(btn.dataset.type === state.chartType) {
                    btn.className = "chart-toggle px-3 py-1 rounded-md transition-all bg-brand-600 text-white shadow-md";
                } else {
                    btn.className = "chart-toggle px-3 py-1 rounded-md transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white";
                }
            });
        };

        // --- UI & TABLE ---
        const updateUI = () => {
            elements.table.innerHTML = '';
            const filter = el('search-input').value.toLowerCase();
            const filtered = state.logs.filter(l => l.subject.toLowerCase().includes(filter) || (l.comments||'').toLowerCase().includes(filter) || (l.type||'').toLowerCase().includes(filter));
            
            if (filtered.length === 0) el('empty-state').classList.remove('hidden');
            else el('empty-state').classList.add('hidden');

            filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(log => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b dark:border-gray-700";
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-8 rounded-full" style="background:${state.colors[log.subject] || '#ccc'}"></div>
                            <div>
                                <div class="font-medium dark:text-gray-200">${log.subject}</div>
                                <div class="text-xs text-gray-500">${log.type || 'Geral'} ‚Ä¢ <span class="math-tex">${log.comments ? log.comments.substring(0,40) : ''}</span></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-gray-500 dark:text-gray-400 text-xs">
                        ${log.date.split('-').reverse().join('/')}
                    </td>
                    <td class="px-4 py-3 font-mono text-xs dark:text-gray-300">
                        ${log.duration}
                    </td>
                    <td class="px-4 py-3 text-right flex justify-end gap-2">
                         <button onclick="editLog(${log.id})" class="text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 p-1.5 rounded-md transition-colors" title="Editar"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="deleteLog(${log.id})" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1.5 rounded-md transition-colors" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                elements.table.appendChild(row);
            });
            lucide.createIcons();
            
            // Trigger MathJax re-render
            if (window.MathJax) {
                MathJax.typesetPromise && MathJax.typesetPromise();
            }

            const subjects = [...new Set(state.logs.map(l => l.subject))];
            elements.subjectList.innerHTML = subjects.map(s => `<option value="${s}">`).join('');

            calculateKPIs(filtered);
            renderHeatmap(filtered);
            renderChart(filtered);
            checkReminders();
        };

        // --- GLOBAL ACTIONS ---
        window.deleteLog = (id) => {
            if(confirm('Apagar registro?')) {
                state.logs = state.logs.filter(l => l.id !== id);
                if(state.editingId === id) endEditMode();
                saveData();
                showToast("Registro apagado", "error");
            }
        };

        el('search-input').oninput = updateUI;
        
        document.querySelectorAll('.chart-toggle').forEach(btn => {
            btn.onclick = (e) => {
                state.chartType = e.target.dataset.type;
                updateUI();
            }
        });

        el('dark-mode-toggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('studyLogDarkMode', isDark);
            updateUI();
        };

        const checkReminders = () => {
            el('reminders-section').innerHTML = '';
            const today = getLocalDateStr(new Date());
            const due = state.logs.filter(l => l.reminder && l.reminder <= today);
            
            if(due.length) {
                const div = document.createElement('div');
                div.className = "bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded shadow-sm flex items-start gap-3 dark:bg-yellow-900/20 dark:border-yellow-600";
                div.innerHTML = `
                    <i data-lucide="bell-ring" class="w-5 h-5 text-yellow-600 dark:text-yellow-400 mt-0.5"></i>
                    <div>
                        <h4 class="font-bold text-yellow-800 dark:text-yellow-200 text-sm">Hora de Revisar!</h4>
                        <ul class="text-xs text-yellow-700 dark:text-yellow-300 mt-1 list-disc list-inside">
                            ${due.map(l => `<li>${l.subject} (${l.date.split('-').reverse().join('/')})</li>`).join('')}
                        </ul>
                    </div>
                `;
                el('reminders-section').appendChild(div);
                lucide.createIcons();
            }
        };

        document.querySelectorAll('.reminder-shortcut').forEach(btn => {
            btn.onclick = (e) => {
                const currentVal = el('date').value;
                let d;
                if(currentVal) {
                    const parts = currentVal.split('-');
                    d = new Date(parts[0], parts[1]-1, parts[2]);
                } else {
                    d = new Date();
                }
                d.setDate(d.getDate() + parseInt(e.target.dataset.days));
                el('reminder-date').value = getLocalDateStr(d);
            };
        });

        el('subject').addEventListener('input', (e) => {
            if(state.colors[e.target.value]) el('subject-color').value = state.colors[e.target.value];
        });

        const showToast = (msg, type) => {
            const t = document.createElement('div');
            t.className = `px-4 py-2 rounded shadow-lg text-white text-sm font-medium animate-bounce ${type === 'error' ? 'bg-red-500' : 'bg-green-600'}`;
            t.textContent = msg;
            elements.toast.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        };

        el('export-json-btn').onclick = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ logs: state.logs, colors: state.colors }));
            const link = document.createElement('a');
            link.setAttribute("href", dataStr);
            link.setAttribute("download", "study_backup_" + getLocalDateStr(new Date()) + ".json");
            link.click();
        };
        
        el('export-csv-btn').onclick = () => {
            if (state.logs.length === 0) {
                showToast("Sem dados para exportar", "error");
                return;
            }
            const headers = ["ID", "Assunto", "Tipo", "Data", "Dura√ß√£o", "Coment√°rios"];
            const rows = state.logs.map(log => [
                log.id,
                `"${(log.subject || '').replace(/"/g, '""')}"`,
                log.type || '',
                log.date,
                log.duration,
                `"${(log.comments || '').replace(/"/g, '""')}"`
            ]);
            const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `study_export_${getLocalDateStr(new Date())}.csv`;
            link.click();
            showToast("CSV exportado com sucesso!", "success");
        };

        el('import-json').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if(data.logs) {
                        state.logs = data.logs;
                        state.colors = data.colors || {};
                        saveData();
                        showToast("Backup restaurado com sucesso!", "success");
                    }
                } catch(err) {
                    showToast("Erro ao ler arquivo JSON", "error");
                }
            };
            reader.readAsText(file);
        };

        // Initialize and Fix Data
        state.logs.forEach(log => {
            if (log.duration && (log.duration.includes('NaN') || log.duration === '0h 00m')) {
                log.duration = calcDurationStr(log.startTime, log.endTime);
            }
        });
        saveData();

        el('date').value = getLocalDateStr(new Date());
        updateUI();

    </script>
</body>
</html>
